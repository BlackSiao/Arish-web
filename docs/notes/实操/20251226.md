---
title: '20251226'
createTime: 2025/12/26 10:43:51
permalink: /notes/实操/z8j1ejic/
---

# Iptables 端口加固操作文档（SSH / HTTPS / RabbitMQ）

## 一、目的说明

针对安全部门扫描发现的以下端口风险：

- **22**（SSH）
- **443**（SSL / HTTPS）
- **15672**（RabbitMQ Management）

在 **不升级组件、不影响现网 DNS 服务** 的前提下，通过 **iptables 白名单控制** 的方式进行加固整改。

---

## 二、操作前准备

### 2.1 操作原则

- 不修改 DNS 相关端口（53 TCP / UDP）
- 不修改默认策略（INPUT / OUTPUT / FORWARD 仍为 ACCEPT）
- 所有变更 **可回滚**
- 严格控制规则顺序

---

## 三、操作前备份现有 iptables 规则（必须）

### 3.1 保存当前规则

```bash
iptables-save > /root/iptables.backup.$(date +%F_%H%M%S)
````

> 说明：
> 若操作过程中出现异常，可通过 `iptables-restore` 快速回滚。

```回滚操作(核验完成)
iptables-restore < /root/iptables.backup.xx
```
这个命令一执行：

- 当前 iptables 规则 全部清空
- 再按备份文件 完整重建
---

### 3.2 验证备份文件

```bash
ls -l /root/iptables.backup.*
```

## 四、22 端口（SSH）加固操作

### 4.1 原有状态说明（变更前）

* 已存在以下 SSH 放通规则：

  * 网段：`10.248.31.128/26`
  * 单 IP：`10.21.198.129` 等
  * 单 IP：`10.210.198.129`
* 其他来源访问 22 端口被 DROP

---

### 4.2 查看当前 22 端口规则顺序

```bash
iptables -L INPUT -n --line-number | grep dpt:22
```

示例：

```text
3  ACCEPT tcp -- 10.248.31.128/26   0.0.0.0/0  tcp dpt:22
4  ACCEPT tcp -- 10.21.198.129      0.0.0.0/0  tcp dpt:22
5  DROP   tcp -- 0.0.0.0/0          0.0.0.0/0  tcp dpt:22
```

---

### 4.3 删除原有 22 端口规则（从下往上）

> ⚠️ 注意：必须从 **最大行号向上删除**，避免规则错位

```bash
iptables -D INPUT 5  # !!!必须先删除掉DROP ALL的操作
iptables -D INPUT 4
iptables -D INPUT 3
```

---

### 4.4 添加新的 SSH 白名单规则（/32 精确控制）

```bash
for ip in \
10.248.31.186 \
10.248.31.156 \
10.248.31.162 \
192.168.58.226 \
192.168.58.239 \
10.210.198.129 \
10.210.198.130 \
10.210.198.131 \
10.246.201.41 \
10.246.201.42 \
10.246.201.43
do
  iptables -A INPUT -p tcp -s $ip --dport 22 -j ACCEPT
done

# 拒绝其他所有 SSH 访问
iptables -A INPUT -p tcp --dport 22 -j DROP
```

---

### 4.5 22 端口规则状态（变更后）

```bash
iptables -L INPUT -n --line-number | grep dpt:22
```

预期结果：

* 仅允许上述 /32 IP
* 不再存在原有 /26 或旧 IP 放通

---

## 五、443 端口（HTTPS / SSL）加固操作

### 5.1 添加 443 端口白名单规则

```bash
for ip in \
10.248.31.186 \
10.248.31.156 \
10.248.31.162 \
192.168.58.226 \
192.168.58.239 \
10.210.198.129 \
10.210.198.130 \
10.210.198.131 \
10.246.201.41 \
10.246.201.42 \
10.246.201.43
do
  iptables -A INPUT -p tcp -s $ip --dport 443 -j ACCEPT
done
```

---

### 5.2 拒绝其他所有 443 访问

```bash
iptables -A INPUT -p tcp --dport 443 -j DROP
```

---

### 5.3 443 端口规则验证

```bash
iptables -L INPUT -n --line-number | grep dpt:443
```

---

## 六、RabbitMQ（15672）端口封禁

### 6.1 背景说明

* 15672 为 RabbitMQ 管理控制台端口
* 不应对外暴露
* 安全扫描必报风险端口

---

### 6.2 仅允许本机访问（推荐）

```bash
iptables -I INPUT -p tcp -s 127.0.0.1 --dport 15672 -j ACCEPT
iptables -A INPUT -p tcp --dport 15672 -j DROP
```

> 若 RabbitMQ 管理端口不使用，可直接 DROP 全部访问。

---

## 七、操作后检查与验证

### 7.1 规则检查

```bash
iptables -L INPUT -n --line-number | egrep '22|443|15672'
```

---

### 7.2 DNS 服务验证（关键）

```bash
dig @127.0.0.1 example.com
dig +tcp @127.0.0.1 example.com
```

> 预期：DNS 查询正常，未受影响

---
---

## 九、整改结果说明（对外口径）

> 已对 SSH、HTTPS、RabbitMQ 管理端口实施访问源地址白名单加固，
> 非授权 IP 已无法访问相关端口，
> 安全扫描涉及端口风险已完成收敛，
> 现网 DNS 服务未受影响。

---

