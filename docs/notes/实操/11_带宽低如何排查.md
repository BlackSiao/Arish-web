**带宽低排查指南（SOP）**

## 概要
本文档整理一套排查“带宽使用率低”的系统化流程，适用于云/物理服务器运维场景。目标是快速判断是“客户无流量”“服务器能力受限”还是“网络链路问题”，并给出判断方法与常用命令。

---

## 快速检查清单（概览）
- Step 1：确认是否存在业务流量需求（客户端是否已切流量）
- Step 2：检查服务器资源（CPU / 内存 / IO / 网卡）是否成为瓶颈
- Step 3：检查网络链路质量（丢包 / 延迟 / 上游带宽利用）
- 最后：根据定位结果联系客户 / 上游 / 调整监控告警
---

## 详细排查流程

### 1) 确认是否有流量需求（是否真的有流量）
为什么要看这一项：很多“带宽低”只是因为业务还没切量或处于低峰期。

检查项：
- 查看容器/进程是否在运行

```bash
docker ps
docker stats
```

- 检查系统负载与连接数

```bash
top -c
ss -anut | wc -l       # 当前 TCP和UDP 连接数
netstat -an | grep ESTABLISHED
```

- 检查磁盘、历史流量趋势

```bash
df -h
sar -n DEV 1 10       # 观察 rxkB/s / txkB/s 的历史变化
vnstat -d             # 查看日/历史带宽趋势（如果安装了 vnStat）
```

判断提示：
- 连接数接近 0 → 很可能没流量进来（询问客户是否已切量/正在灰度/是否在低峰期）
- 检查时区与业务高峰

### 2) 服务器是否有能力跑起来（主机资源检查）
如果确认有流量但带宽低，判断服务器是否是瓶颈。

检查项：

```bash
vmstat 1            # CPU / IO / 中断 / 上下文切换等
top / htop          # 观察 CPU 使用率、进程占用
```

- 关注点：
	- CPU 是否接近 100%（若是，可能是发包能力不足）
	- 单线程应用是否成为瓶颈（如 nginx worker 数量、Java 线程池、Node 单线程）
	- IO / 磁盘负载异常也可能影响应用吞吐

- 网卡速率与状态：

```bash
ethtool eth0
# 查看是否为 10000Mb/s（10Gbps）、是否降速到 1000Mb/s、是否为半双工等
```

判断提示：
- CPU 满载但网络低 → 可能应用/CPU 瓶颈
- CPU 空闲但流量上不去 → 可能单线程程序、连接/线程配置或网卡限制

### 3) 网络链路检查（运营商 / 交换机 / 上游）
当主机资源没问题但仍存在带宽低时，检查网络质量与上游链路。

常用命令与含义：

```bash
ping <目标IP>           # 基本连通性与延迟
mtr <目标IP>            # 路径中的各跳延迟与丢包情况（实时）
ss -s                   # 查看 socket 状态统计（包含重传）
tcptraceroute <目标IP>  # TCP 路径跟踪（若可用）
```

关注点：
- 丢包、RTT 高、TCP 重传多 → 说明链路质量差或上游丢包
- 中间设备（交换机）是否对端口限速或配置了 QoS
- 上游出口是否拥堵（例如总出口 100G，但卖出 200G）→ 资源超售

判断提示：
- 若有明显丢包/重传 → 提交工单给网络/上游或与运营商沟通
- 若链路质量正常但带宽仍低 → 返回第 2 步，复核主机或应用层限制

---

## 标准 SOP（可复用的操作步骤）
1. 确认客户是否已部署并切量（无流量则结束）
2. 查看当前连接数与历史流量（`ss`, `sar`, `vnstat`）
3. 查看主机资源（`vmstat 1`, `top`, `ethtool`）
4. 查看网络链路（`ping`, `mtr`, `ss -s`）
5. 根据定位结果：
	 - 客户端/部署问题：通知客户或等待切量
	 - 服务器资源瓶颈：提升规格或优化应用（与开发/客户协调）
	 - 链路问题：工单给网络/上游或与运营商沟通

---

## 常见原因与处理建议
- 客户未切流量：沟通确认，建议客户完成 DNS/灰度切换
- CPU 或单线程瓶颈：建议扩容 CPU、增加 worker、优化应用并发
- 网卡速率/半双工：检查物理链路和交换机配置，修复后验证
- 运营商/上游拥堵：与上游运营商沟通，或申请更高带宽/调整线路

---


