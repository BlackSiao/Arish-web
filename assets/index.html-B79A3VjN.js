import{_ as s,c as i,d as a,o as t}from"./app-UDSOE8tV.js";const n={};function l(r,e){return t(),i("div",null,[...e[0]||(e[0]=[a(`<h2 id="问题描述" tabindex="-1"><a class="header-anchor" href="#问题描述"><span>问题描述</span></a></h2><p>当一个进程启动失败且未留下有效 PID 时，无法直接使用 <code>strace -p &lt;pid&gt;</code> 附加追踪系统调用。此类失败通常发生在 <strong>execve() 系统调用之前或期间</strong>，进程尚未完全替换为目标程序。此时需从启动链路的早期阶段入手排查。</p><h2 id="进程启动链路概述" tabindex="-1"><a class="header-anchor" href="#进程启动链路概述"><span>进程启动链路概述</span></a></h2><p>一个典型进程的启动流程如下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>启动器（shell / systemd / supervisor 等）</span></span>
<span class="line"><span>  ↓ fork()</span></span>
<span class="line"><span>  ↓ execve()</span></span>
<span class="line"><span>  ↓ 动态链接器（ld.so）加载依赖库</span></span>
<span class="line"><span>  ↓ 程序初始化（全局构造函数等）</span></span>
<span class="line"><span>  ↓ main()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>各阶段作用简述：</p><ul><li><strong>fork()</strong>：创建新进程，复制父进程上下文。解决“是否有新进程”的问题。</li><li><strong>execve()</strong>：替换进程镜像为目标程序。PID 不变，但代码、内存等全部更换。</li><li><strong>ld.so</strong>：动态链接器，负责加载共享库并进行符号重定位。</li><li><strong>程序初始化</strong>：执行全局变量初始化、C++ 静态构造函数等。</li><li><strong>main()</strong>：用户代码入口。</li></ul><h2 id="常见失败阶段及排查方法" tabindex="-1"><a class="header-anchor" href="#常见失败阶段及排查方法"><span>常见失败阶段及排查方法</span></a></h2><h3 id="_1-fork-失败-较少见" tabindex="-1"><a class="header-anchor" href="#_1-fork-失败-较少见"><span>1. fork() 失败（较少见）</span></a></h3><p><strong>表现</strong>：</p><ul><li>systemd 日志：<code>Failed to fork: Resource temporarily unavailable</code></li></ul><p><strong>常见原因</strong>：</p><ul><li>进程数达到上限（<code>ulimit -u</code> 或系统限制）</li><li>内存不足</li></ul><p><strong>排查</strong>：</p><ul><li>检查 <code>dmesg</code> 或 systemd 日志（<code>journalctl -u yourservice</code>）</li><li>查看系统资源：<code>ulimit -u</code>、<code>free -h</code>、<code>cat /proc/sys/kernel/pid_max</code></li></ul><h3 id="_2-execve-失败-最常见" tabindex="-1"><a class="header-anchor" href="#_2-execve-失败-最常见"><span>2. execve() 失败（最常见）</span></a></h3><p><strong>表现</strong>：</p><ul><li>进程快速退出，无 PID 残留</li><li>systemd 状态：<code>code=exited, status=203/EXEC</code> 或类似 execve 相关错误</li></ul><p><strong>常见原因及错误信息</strong>：</p><table><thead><tr><th>错误信息</th><th>可能原因</th></tr></thead><tbody><tr><td>No such file or directory</td><td>可执行文件不存在 <strong>或</strong> 动态链接器（interpreter）路径错误</td></tr><tr><td>Permission denied</td><td>无执行权限（chmod +x）</td></tr><tr><td>Exec format error</td><td>ELF 头错误、架构不匹配（32/64位）</td></tr><tr><td>No such file or directory</td><td>共享库缺失（常误报为文件不存在）</td></tr></tbody></table><p><strong>排查方法</strong>：</p><ul><li><strong>直接使用 strace 启动命令</strong>（推荐首选）：<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>strace -f -o /tmp/startup.log your_command</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div>或针对 systemd 服务：<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>systemctl stop yourservice</span></span>
<span class="line"><span>strace -f -o /tmp/startup.log /path/to/your/binary [args]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><code>-f</code> 选项会跟随 fork 的子进程，捕获 execve 前后的系统调用。</li><li>检查文件存在及权限：<code>ls -l /path/to/binary</code>、<code>file /path/to/binary</code></li><li>使用 <code>ldd</code> 检查依赖：<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>ldd /path/to/binary</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div>若报 “not a dynamic executable” 或缺失库，即为动态链接器问题。</li><li>检查 ELF interpreter：<div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>readelf -l /path/to/binary | grep interpreter</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div>确保列出的 <code>/lib/ld-linux-x86-64.so.2</code> 等文件存在。</li></ul><h3 id="_3-ld-so-动态链接器-阶段失败" tabindex="-1"><a class="header-anchor" href="#_3-ld-so-动态链接器-阶段失败"><span>3. ld.so（动态链接器）阶段失败</span></a></h3><p><strong>表现</strong>：</p><ul><li>进程启动后立即退出</li><li>systemd：<code>status=127</code></li><li>shell 下：<code>error while loading shared libraries</code></li></ul><p><strong>排查</strong>：</p><ul><li>同上，使用 <code>strace -f</code> 捕获加载库的 open() 调用失败</li><li><code>ldd /path/to/binary</code> 查看缺失库</li></ul><h3 id="_4-程序初始化阶段卡住或失败" tabindex="-1"><a class="header-anchor" href="#_4-程序初始化阶段卡住或失败"><span>4. 程序初始化阶段卡住或失败</span></a></h3><p><strong>表现</strong>：</p><ul><li>进程存在（有 PID），但 CPU 占用 0%，无日志输出</li><li>systemd 显示 <code>activating</code> 状态长时间不变</li></ul><p><strong>排查</strong>：</p><ul><li>若有 PID，可直接 <code>strace -p &lt;pid&gt;</code></li><li>检查程序日志、core dump</li><li>常见原因：全局构造函数死锁、runtime 初始化问题</li></ul><h3 id="_5-systemd-服务特殊机制" tabindex="-1"><a class="header-anchor" href="#_5-systemd-服务特殊机制"><span>5. systemd 服务特殊机制</span></a></h3><p>systemd 通过 fork() 获取子进程 PID，并将其置入 cgroup 进行监控。这也是 <code>systemctl status</code> 显示 Main PID 的原理。</p><p>若服务启动失败：</p><ul><li>查看详细日志：<code>journalctl -u yourservice -xe</code></li><li>临时修改 unit 文件添加调试：<code>ExecStart=/bin/strace -f -o /tmp/service.log /original/binary</code></li></ul><h2 id="实用命令示例" tabindex="-1"><a class="header-anchor" href="#实用命令示例"><span>实用命令示例</span></a></h2><ul><li><p><strong>追踪启动过程</strong>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>strace -ff -o /tmp/trace.log your_command</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>（<code>-ff</code> 将子进程输出分离到不同文件，便于分析）</p></li><li><p><strong>shell 脚本启动追踪</strong>：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>strace -f -o /tmp/xx.log ./your_script.sh</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><strong>bash 作为父进程示例</strong>： bash 本身是一个普通进程（有 PID/PPID），可 fork/exec 子进程：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-"><span class="line"><span>ps aux | grep bash</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>进程启动失败且无 PID 时，核心思路是<strong>在启动命令前置 strace</strong>，使用 <code>-f</code> 选项捕获 fork/execve 全过程。这能精准定位失败的系统调用（如 open、execve 返回 -ENOENT）。结合 <code>ldd</code>、<code>readelf</code> 和 systemd 日志，通常可快速解决问题。</p>`,40)])])}const o=s(n,[["render",l]]),c=JSON.parse('{"path":"/notes/Linux/ermzintw/","title":"Untitled-1","lang":"zh-CN","frontmatter":{"title":"Untitled-1","createTime":"2025/12/29 15:45:59","permalink":"/notes/Linux/ermzintw/","description":"问题描述 当一个进程启动失败且未留下有效 PID 时，无法直接使用 strace -p <pid> 附加追踪系统调用。此类失败通常发生在 execve() 系统调用之前或期间，进程尚未完全替换为目标程序。此时需从启动链路的早期阶段入手排查。 进程启动链路概述 一个典型进程的启动流程如下： 各阶段作用简述： fork()：创建新进程，复制父进程上下文。解...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Untitled-1\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2026-02-10T08:07:34.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://blackhsiao.com/notes/Linux/ermzintw/"}],["meta",{"property":"og:site_name","content":"Black Hsiao 的技术笔记"}],["meta",{"property":"og:title","content":"Untitled-1"}],["meta",{"property":"og:description","content":"问题描述 当一个进程启动失败且未留下有效 PID 时，无法直接使用 strace -p <pid> 附加追踪系统调用。此类失败通常发生在 execve() 系统调用之前或期间，进程尚未完全替换为目标程序。此时需从启动链路的早期阶段入手排查。 进程启动链路概述 一个典型进程的启动流程如下： 各阶段作用简述： fork()：创建新进程，复制父进程上下文。解..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-02-10T08:07:34.000Z"}],["meta",{"property":"article:modified_time","content":"2026-02-10T08:07:34.000Z"}]]},"readingTime":{"minutes":3.17,"words":952},"git":{"createdTime":1770710854000,"updatedTime":1770710854000,"contributors":[{"name":"BlackSiao","username":"BlackSiao","email":"1546600539@qq.com","commits":1,"avatar":"https://avatars.githubusercontent.com/BlackSiao?v=4","url":"https://github.com/BlackSiao"}]},"autoDesc":true,"filePathRelative":"notes/Linux/进程和系统.md","headers":[]}');export{o as comp,c as data};
