import{_ as i,c as a,b as e,o as t}from"./app-DNjG2iId.js";const n={};function l(r,s){return t(),a("div",null,[...s[0]||(s[0]=[e('<h2 id="简单介绍" tabindex="-1"><a class="header-anchor" href="#简单介绍"><span>简单介绍</span></a></h2><p>DNS 劫持是一种非常常见的攻击方式，从名字即可看出，其核心原理是通过篡改 DNS 解析过程，将用户引导至恶意网站或服务器。以下是常见的 DNS 劫持类型：</p><ul><li><strong>本地 DNS 劫持</strong>：攻击者在用户的计算机上安装病毒，然后修改本地 DNS 设置，将用户请求重新路由到有害网站。</li><li><strong>使用路由器劫持 DNS</strong>：许多路由器的安全策略较差，或使用默认密码。攻击者可利用此漏洞入侵路由器并更改其 DNS 设置，从而影响所有使用该路由器的用户。</li><li><strong>中间人（MITM）攻击</strong>：攻击者使用中间人攻击技术拦截用户与 DNS 服务器之间的通信，然后将目标定向到恶意网站。</li><li><strong>恶意 DNS 服务器</strong>：黑客可更改 DNS 服务器上的 DNS 记录，使 DNS 请求被重新路由到恶意网站。如果网站伪装得足够逼真，用户可能甚至察觉不到异常。</li></ul><h2 id="实际案例" tabindex="-1"><a class="header-anchor" href="#实际案例"><span>实际案例</span></a></h2><p>在处理客户故障时，尤其面对教育网环境，这种 DNS 劫持问题更为普遍。下面以【广东职业技术大学】的一次 DNS 故障为例，说明如何定位 DNS 被劫持。</p><h3 id="客户现网环境" tabindex="-1"><a class="header-anchor" href="#客户现网环境"><span>客户现网环境</span></a></h3><ul><li><strong>故障信息</strong>：域名 <code>lms.gdpt.edu.cn.</code> 解析有问题。该域名已配置对应的权威记录，且两台 DNS 设备均已配置该域名。但如果将该域名的请求发送到禅城校区的 DNS 服务器，则会出现出网递归（即请求被转发到外部递归服务器）。</li><li><strong>现网架构</strong>：Master（10.100.0.200） + Backup（10.29.0.200）。</li></ul><h3 id="排查步骤" tabindex="-1"><a class="header-anchor" href="#排查步骤"><span>排查步骤</span></a></h3><p>收到此类 DNS 解析异常时，通常按以下三步初步排查：</p><ol><li><strong>确认客户权威区记录</strong>：检查权威区中是否确有对应记录。</li><li><strong>确认终端命中 ACL</strong>：验证用于解析的终端是否能命中对应视图中的 ACL（访问控制列表）。</li><li><strong>尝试终端解析域名</strong>：使用终端解析 <code>lms.gdpt.edu.cn.</code> 该域名，查看解析结果，并检查解析日志。</li></ol><p>在本次案例中：</p><ul><li>客户现网确已配置该记录，且视图设置了对应的 ACL。</li><li>通过判断，确认终端可命中视图 ACL，并应得到内网域名解析结果。因此，前台配置无误。</li></ul><p>进一步测试：</p><ul><li>使用对应 ACL 中的终端解析该域名，发现确实出现出网递归。</li><li><strong>关键发现</strong>：从禅城 DNS 的解析日志中，看不到任何对应记录。从后台查看 <code>query.log</code> 日志，也无相关记录。此时，已有充分理由怀疑 DNS 流量被劫持：DNS 请求根本未到达禅城 DNS 设备，而是中途被其他设备（最可能是防火墙）转发出网。</li></ul><h3 id="进一步确认劫持" tabindex="-1"><a class="header-anchor" href="#进一步确认劫持"><span>进一步确认劫持</span></a></h3><p>在禅城 DNS 后台开启抓包：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tcpdump</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -i</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> any</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -nnv</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">lms.gdpt.edu.cn.</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>为更精确验证 DNS 劫持，可尝试使用 <code>dig +tcp</code> 进行测试：</p><ul><li>平时 DNS 查询默认使用 UDP 53 端口（开销小、效率高），但 UDP 无连接握手，易被伪造响应包，导致劫持或污染。</li><li>切换到 TCP 53 端口需三次握手，并有严格校验机制，伪造难度更高。</li><li><strong>测试方法</strong>：如果 UDP 模式下解析结果与 TCP 模式下不一致，则高度怀疑 UDP 流量被劫持或污染。</li></ul><p><strong>注意</strong>：<code>dig +tcp</code> 主要用于验证排查，无法完全避免劫持（高级攻击仍可能干扰 TCP）。此外，TCP 模式开销更大，通常仅在数据包超 512 字节或启用 DNSSEC 时自动切换。 通过以上步骤，最终定位并解决了劫持问题，确保域名正确解析至内网。</p>',20)])])}const d=i(n,[["render",l]]),h=JSON.parse('{"path":"/notes/%E5%AE%9E%E6%93%8D/l09d0g8o/","title":"DNS劫持","lang":"zh-CN","frontmatter":{"title":"DNS劫持","createTime":"2025/10/05 10:24:13","permalink":"/notes/实操/l09d0g8o/"},"readingTime":{"minutes":3.27,"words":980},"git":{"createdTime":1759802183000,"updatedTime":1759802183000,"contributors":[{"name":"BlackSiao","username":"BlackSiao","email":"1546600539@qq.com","commits":1,"avatar":"https://avatars.githubusercontent.com/BlackSiao?v=4","url":"https://github.com/BlackSiao"}]},"filePathRelative":"notes/实操/DNS劫持.md","headers":[],"categoryList":[{"id":"4358b5","sort":10000,"name":"notes"},{"id":"9d4d99","sort":10001,"name":"实操"}]}');export{d as comp,h as data};
